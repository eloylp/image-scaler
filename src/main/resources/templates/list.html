<html lang="en">
<head>
  <meta charset="UTF-8">
  <title th:text="${appName}">${appName}</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
  <style>
    .image-block {
      margin: 50px 0 50px 0;
    }
  </style>

</head>
<body>

<div class="container">
  <div class="row">
    <div class="col-sm">
      <div class="text-center">
        <h1 th:text="${appName}"></h1>
        <h6>Uploaded images</h6>
      </div>
      <hr>
      <div>
        <div id="image-container" class="text-center">

        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
        integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
        crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
        integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
        crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
        integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
        crossorigin="anonymous"></script>
<script src="https://unpkg.com/axios/dist/axios.min.js"></script>
<script>

async function getImages () {
  try {
    const response = await axios.get('/images')
    return response.data
  } catch (err) {
    console.error(err)
  }
}

async function getImage (image) {
  const placeholderGeneratorUrl = `https://via.placeholder.com`
  try {
    const localImageUrl = `/images/${image.uuid}`
    await axios.get(localImageUrl)
    return localImageUrl
  } catch (err) {
    return `${placeholderGeneratorUrl}/${image.imageInfo.scale.width}x${image.imageInfo.scale.height}`
  }
}

async function getImageStore (images) {

  return images.reduce(async (acc, image) => {
    acc = await acc
    if (!(image.groupUuid in acc)) {
      acc[image.groupUuid] = []
    }
    image.data = await getImage(image)
    acc[image.groupUuid].push(image)
    return acc
  }, {})
}

function findGroupInStore (group, imageStore) {
  return imageStore[group]
}

function getCookie (cname) {
  var name = cname + '='
  var decodedCookie = decodeURIComponent(document.cookie)
  var ca = decodedCookie.split(';')
  for (var i = 0; i < ca.length; i++) {
    var c = ca[i]
    while (c.charAt(0) === ' ') {
      c = c.substring(1)
    }
    if (c.indexOf(name) === 0) {
      return c.substring(name.length, c.length)
    }
  }
  return null
}

function orderGroup (group) {
  return group.sort(({ imageInfo: iia }, { imageInfo: iib }) => {
    return iia.scale.width * iia.scale.height - iib.scale.width * iib.scale.height
  })
}

function orderImageStore (imageStore) {
  for (const key in imageStore) {
    if (imageStore.hasOwnProperty(key)) {
      imageStore[key] = orderGroup(imageStore[key])
    }
  }
}

function drawGroup (container, group) {

  const images = group.map(({ data, name, original, imageInfo }) => {
    const caption = original ? 'Original' : `${imageInfo.scale.width}x${imageInfo.scale.height}`

    return `<figure class="figure">
      <img src="${data}" class="rounded float-left" alt="${name}">
      <figcaption class="figure-caption text-center">${caption}</figcaption>
      </figure>
    `
  })
  const imageBlock = document.createElement('div')
  imageBlock.classList.add('image-block')
  const [firstGroup] = group
  imageBlock.innerHTML = `
    <fieldset>
      <legend>${firstGroup.name}</legend>
      ${images.join('')}
    </fieldset>
  `
  container.append(imageBlock)
}

(async () => {

  const imageZone = document.querySelector('#image-container')
  const images = await getImages()
  const imageStore = await getImageStore(images)
  orderImageStore(imageStore)
  const lastUploadedGroupUuid = getCookie('Image-Scaler-Last-Uploaded-Group')
  if (lastUploadedGroupUuid) {
    const lastUploadedGroup = findGroupInStore(lastUploadedGroupUuid, imageStore)
    if (lastUploadedGroup) {
      delete imageStore[lastUploadedGroupUuid]
      drawGroup(imageZone, lastUploadedGroup)
    }
  }
  const groups = Object.values(imageStore)
  for (const group of groups) {
    drawGroup(imageZone, group)
  }
})()

</script>
</body>
</html>